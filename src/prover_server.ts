import fastify, { FastifyRequest, FastifyReply } from 'fastify';
import {
  Field,
  MerkleMap,
  PrivateKey,
  PublicKey,
  Scalar,
  Signature,
} from 'snarkyjs';
import {
  Transaction,
  UTXO,
  callContract,
  compile,
  createStepInfos,
  generateProofsParellel,
  mergeProofs,
} from './Rollup.js';
import IORedis from 'ioredis';
import { Queue, RedisConnection, Worker } from 'bullmq';
import { putFile } from './filecoin.js';

declare module 'fastify' {
  interface FastifyInstance {
    proofQueue: Queue;
  }
}

const server = fastify();

const connection = new IORedis({
  maxRetriesPerRequest: null,
  enableReadyCheck: false,
});

const proofQueue = new Queue('proof', { connection: connection });
server.decorate('proofQueue', proofQueue);

let commitmentMap = new MerkleMap();
let nullifierMap = new MerkleMap();

const utxo_hashes = [
  "15645817794972014182820101287888450927373373022063470913663254473932773106161",
  "18196865562484927381802024642756791997767679150221996974733202383903208389019",
  "19750264991971982490161017447047264158055818772173663193895373135518952879621",
  "21604556824332925265578165056105015299973734604607258220495817504476433176052",
  "19136431115593499064413794112893128291866070860478921719816790455911982689091",
  "13289359758922795051306764065159310182773664355488498604083606953182170425915",
  "19068155477386177784208808162311900276383372020089429288121193551015961214453",
  "6654869006987521473956956921669059992988654941999075992685411870109135458520",
  "18804271332347149771844066037976112311921181652013934227360466562589927546828",
  "20740435219505495603936840859240347648755603585919525620330955929026865763930",
  "9938818324855313019804783395204757106174828294585289052385009474731441809510",
  "9536834328661783001395236800456629399201777717957144977142907118559145888086",
  "20859932200126778176733717411652479176479903491730387065268067835657187783232",
  "27500047494771561119372594475317399220294840404447073417563157258030527759100",
  "9356181137924143644729754370388264220619320424438922559433392320545682882826",
  "17508175942226921464866304982980591742532306152744138572899405126442702849048",
  "14808545141761710701442754318917691738027637481219182484061944526281011913726",
  "9132566317036848066903918923821924345918365736274442499891413071073753193381",
  "15212288548083669351909947077918248042683420940590414287962583454650616004771",
  "5476140472219053646187411995387252072862987312908169836603564244461024884082",
  "26004114075467916535328910527398879374912959794991813275208136136404741452584",
  "22999512795412997073988411712657797380997046315124670846515795504611142539771",
  "19090990607292217153782901624011725828009044152456073134315207941967297733147",
  "27675260454139726962669681904086110029192235748012320329377415603411028259095",
  "11101312280241369888192495782617023650933128551824863714793366676983911500170",
  "21364710406794632570166627060730717540648327601773007930799137262716236379107",
  "25278295994862938714212503351307633736268830387187848914970727551272650507181",
  "15166173763667799470358738819144344216234877766904879434056656785292134543586",
  "4846000184625772087207345941794351870741654734275557500272077258919117352118",
  "21527208022216467840244145249435176452183173116102104395072964612960236574165",
  "17740899177824298944420210697600940530451355551605253509870332562362904191687",
  "19252015735857295608275098786186741596657697226118183532785738931159505351807",
  "18580936932268894293502251123505898102701534499812610519862547520135936344682",
  "27120546698961969998188234933042511625905290600660499995935879374002563404750",
  "4530998195427118507287011753483169472746903754717166152360467121751744514955",
  "2598414923260275618950944786456448285243556982651056313173215304702892915804",
  "5892652387395945138472478152677553763151587063180436573048862269606519732957",
  "2285469355661620703431746349919268306020382377683234013875262912844904463352",
  "7149609087375374429415002754214672828099776560290318533862024345101492629302",
  "17665587712610860912190899739254022031207158893006476445448072898001748850800",
  "12425986522592664514245947233214777188485745581300341040683930237083185963161",
  "24529531890371028078505544149304429956301236958644828321097689449269563753656",
  "17240953325229581733271656947105686160427785516109192419657609127996643881695",
  "18498190498901231257499270836132105574519171111704645280307450824919113533400",
  "2765275782179178161476758515844997011153710586134579736913213064426403018353",
  "23818889578839236228112140629008740753678990325588139996113099364528852765451",
  "17424691460369594347437205921232783228490869095980673969715450368509458276721",
  "7685335406748123404967245056728757195228110711979414667407420309733671594203",
  "22808769957147936082832557036339504133767117990620938820784952730662057071447",
  "1678244861684495419335846212589637241510003048241146133619640291157085782429",
  "9853395762839315171383021552747956241645859176631500577041169386319138073106",
  "17365441370185817913796653774843257358950606402171082829979651692325146829074",
  "17075748221429486619733953685714686238140439172114427533164670958913729327816",
  "21698182118354176046803865291808132380957816213131950432181049184139792658495",
  "8264005390479954083774969588257242396621918807206470510528316003284843663960",
  "3089656792502054823831449275689427793313342471632178314615948641160050082019",
  "21183654308113236811826737712718429514247085413783174559712453809748453735146",
  "20175488226309818749444573366241471255837164078184208861421405546548662640504",
  "18398691566003869855121015422059169898059481922517186003024727514387911403816",
  "6533114637927794173116665247745754141583901215059652921950620766886747429634",
  "23095125040841555465763728177146474703591732270730456368453452374677815140485",
  "8846943333272721127031542182001360358978490556343754011319474048149817747298",
  "9054293001140268825754234674148452601240842238787188984759018636227435918373",
  "14493365208779395053251070887063758810963617704577783700302073866849096762725",
  "7129137514126112747348193235899375544245589440172926335390556669370961797145",
  "13805230014791798203144260422288638745706632450220553104254600679398681801741",
  "28172162778652720463249413387880698099542702677637372912836118690011659340996",
  "11249101473892202852126278063251797114299493231605352451697263240815036884621",
  "22590080716346855194465308069356183439852805389027108039574830371162581939272",
  "26317400889341477619678302399603515020349807332344199712737100258507628224328",
  "24802018277600949309278441751787960135409121421120087825141773770723701047980",
  "21004694540125261549538073118376151310012842343762768284569493214905913773213",
  "5889236917300272625490420057737397029739031204154106778633256430686298340300",
  "20162455083371868815666438748146629199846835158097810787471341473926047693039",
  "2625394550396915458667765588188644422614926264489575364089418192401077960888",
  "5642352395162051495009325007044363598384729145082484065214854528153102781645",
  "16264135788533901091473068292039404852888349848231483406056818658011448827937",
  "18547305352100246037450697512220305987137129168648494354597647971517859105893",
  "7373919832085823819029149939323844285387138469630431824085547376753359225316",
  "10560086126639727677092963353727335425049572342698086194895901505960452168985",
  "3667766626934621397625560695226469745428086227679556911389499459521994003942",
  "19369947619522912425838061847639990500639762099107119412002896398955887182378",
  "12502433651399416277868884599404025656876667186881713184102028171528736663638",
  "8327698638879529535557749403008471535217087900702316487859541502287885029092",
  "6725154690199169698846884981608682436425457603337001648915795858078673789874",
  "1476098237298711225010383630273174848901113490523413757507056393170638208035",
  "26771246986299779687574425953910687380506390777438693327479847370475213719452",
  "1202655686886378544158940507147976583490198534266879027768012875320266396881",
  "21650827329306005299017184485024702205819798841763575663989945587768071740405",
  "27349686473016515939883279698562877459667559243409221857623726978886617160047",
  "26990158501042765532179282435598377925343895306731732905096675294175945976836",
  "14159782836183200825129026445333917556110600912103977344487174776350440446275",
  "27530014508329425803158352634720449326648674544145101270209974893743457004631",
  "28472252502058553488503303938828110378984818594553176952632989630438082029095",
  "14953989023486694556495676468911858417132010313231887552013017169503360915880",
  "4295934690896321369360795714289415306588278418561437990747069187201129745493",
  "12114261906849093346473412422419742869101648142451691794631085372558763077402",
  "6936180434402215548699215375678637624562961330327538425504664410772431930014",
  "16774908023204355204507666411288037441806669279635013886251220585189398841446",
  "28361291893040745279759130618771326701416875496982055772241946249382758694079",
  "6055505977014862495930680608180254863812899716642067608602166482908594203480",
  "20487272234212748755125415350520322739346693834039237533435852427023591676618",
  "5374549878045145090948227972125673820648922667669726185460460370567391123451",
  "23373459265193470161795878225647828907077692490341398558297019236339459009790",
  "2983934819190273094386247701066754114958028375214627018957972993319184495504",
  "19234523176122447323535818781352753558483040671785067846216217696286897705558",
  "19778739137487269657511853298851209024003105855218284287733032810993772171063",
  "18369978793956388718710008896222710086094313573643449169773370809652267689678",
  "4625141917999274322216605609883601328199939097836653830369116259025608694089",
  "13309291960743428949203368707019991606863320668384825340011089045795766486512",
  "26576183374036139628813532078915832155014429876797860475721522549283902126085",
  "3365879884179955657690361852301320324174116442478060770131595664306086538433",
  "1813827736236081775802911056846788225832638482041793336166665144098922183510",
  "16801146161742081513736649373567504503117211522713807678097756352920648202180",
  "1705355058224570899353132460687649611646196318554922152054345663038163063132",
  "11419202297408398449433884309313954716004701670659567099432136016826897077132",
  "5844433508993958175296660719168760018940040245413174835283791600849616536514",
  "9806384543766850902536729268194909598806949492391759893797342583298247814575",
  "7102918711786349595389154642187343281492947578628766888084688247952296672412",
  "28851998588376748192740188533781694321067584637294908490193497007309103314901",
  "26965126659838728621985367900541143974814773337610696504477402661776329667002",
  "9463984946822291535027917323594302043931713331786198450056967935573143731646",
  "15436712166908361501051084841713027242795223152203888038736480788999601458578",
  "17797034099927813788054991588986091984083545432547540520272623030880426870086",
  "22300129939441140120745071767769000897471350246558928004138675938679974481769",
  "22085939103090930263046211694703692955719068626235879412828084009233565896348",
  "27482324514291984902165774414269759430782287982066133339538139997756113036247",
  "26157498761646630097069040434597077763464494169239378910521409595305086669756",
  "13398920702743074381181769648463946465389196251516629974347905256826946040710",
  "27170573997241537574650627789160320588534945010476447523862692518252689658100",
  "24085303163675492257507691042107583450671010304949059175672395792259043195396",
  "3263579093013884546218676547940023859614691699840377113828048784112400127702",
  "26927840742764153145778812884439247273172753755938596606014732248127974497172",
  "18593185334461567101572438962496423346458397693301861828481819645751268132363",
  "100773587240212363640800646674544412139023844009815029492257834823176892820",
  "6277159861018399405865726296630808496173159585928652754789247689827127772503",
  "1755508414316484032207145253538368984399143696895657289642939718112043834661",
  "17901798998312469055646618894950880537026011995962535944893175452813147544003",
  "14935417987901360731396567616893426221306701080160737324686837342420618684330",
  "3972437763065738759855263584970209234579247931035002959964673063957485627641",
  "19479199381170928612616543661623233871193569880498874864153457117088768570856",
  "13255756271460945354633654618481859578974433774704449063127697683564523788735",
  "19662912735487008849137224165774976081387481086314612546742611488947427415258",
  "24024410595459730096839615949044688505992283538275547991728807857937913468592",
  "8881616313707705436212671631783423355190642729737344443191258160068454022180",
  "26347548499274107388009482744091478071872996119209320579635537979462576122955",
  "13596383981525084539175647566068440503538839039769782111885318612829848535023",
  "20855190926622536302912269046195636248782485775520078113468247044508027061022",
  "13819042654858649278605100432230549601633778969774099459396422111717996249402",
  "26674234572561473258341647438728802131655496779711231276756950448699294216829",
  "15638660165851535690495948134040297381812627693261519458537222001065543384096",
  "12310134857956841592437279429831105349607684940728100961374905533051594458855",
  "3136716567603393787885990565405692635442202839997800141319597476273361722086",
  "22178401629249843981335857535596509803949621069753683790234938636191563296138",
  "28407770551165828806997374782319773508550378798803972008458034347409577177780",
  "27310099141277945121554713644093966106860470686459329863785721396442883335261",
  "23045348387074344566171008611863265615795838578627140007063853459870813916606",
  "15069113212984600488155782449275800557180403521441826144071704361246547720928",
  "6003672494477539449902326330259317704949420706357644687504191810273022052896",
  "24495965869327941811949736275091611814478922815958189153452971369783778020572",
  "20165391929206023954545454539347706963134504069262835775976037775225413267768",
  "3238057791870445789228681166193366940290352188224884052149240625932979322991",
  "13537573290534719472423498006370456141721067333699937823323525481263877117462",
  "24403790173637898667784077216204500579478142009022104496798263797532046825048",
  "8879643667123289217737846543533435413886771745847314603799145231751022122306",
  "4359532873860423283769331442673252252585738031771239779144016684821801043059",
  "21785169961671653927052090018802434884593685807304417337359281017479104577744",
  "12031947184718606397341343542021944036014126136201394416188922198752230264403",
  "14653769536514597098808427863838249175329991418717130892860378099844796863109",
  "7528542024376229176024089102360777570818942554069317679862239727630679061765",
  "25750170901170141450570933195915713563528724022506283342498217111702684953538",
  "2788827949672338949418208401148685838826722250842845147147323234117128194105",
  "28201892489299119339383394159777108578876020592963496896987367776531209185468",
  "23788607998653974531699479310386161920241573315842446568516841381163187098949",
  "10928963308581023205101608982932137904734689216129019701250924389826873332951",
  "24246779895210656491274049176914690387349572828559083421517433940646832668595",
  "7276422098237512089190544919669618029433053856154356776850363711017439983281",
  "23042766089673716110408532405753542256002323393659524042063232922268994505168",
  "21824845399132196840981640899032321579590274149190607206387156109587002052557",
  "3731363175711569331196846067380050022732446684533041089921994067705355823850",
  "20355411082104291747359955539328686998652042973351009011720258999248987524758",
  "19916497210266535494703815406704067701487614974473437500992140602527304670486",
  "27141507026351590683199972301862330263596114274821037398286603025346018490518",
  "11206877313818061337950264005488773908315172000576098652531274071153774107999",
  "26262873848425575745548370043538593746907567894800722376553596968544856063505",
  "9113838368626419917710517804177673923063473909007298352249650444229910015293",
  "16167687907691106821177292630746317442540622203056652986665094357985094737402",
  "10055404012600800326721924854725582838841942229916149306496437514711217547531",
  "20281154544607532363076514920790146124454457286700858891998961080037701304576",
  "6358980179505238272058212321364650821524934702803901136569480864296745432694",
  "11089187203742866859966111387207252290476828679766063945623317602002550775114",
  "10751810772151891489684695322580823987487354383251481488366206429276353906423",
  "22474793947838810432307623479950885194853517640992085430504216924065436483842",
  "18232335684669457473506971970202578861496237097448796337418513869285272822115",
  "26831119639007145765762605701667380849092099557438411849610633431770800477232",
  "25689513854375127223536811296476582828513841659416907295884296284449882399662",
  "27906230753806371017221813636093669990213656057479124192743956612348710801196",
  "23852830721707509602656289249467841961250812364802596561263363876946334007827",
  "9789040647413002597664683975126106793000165137238055357251884802817398056432",
  "17263206476156891647188589427837394422895787337345396684523528945326183506597",
  "25890574651026754041889666636319563480820831729374345917834505684165843951876",
  "25496857849468093285247832851418191618730746040488351775085754198646248453770",
  "25389989366946530538261862915758034735469067721218249604607852402185463109900",
  "28157610735392819234766726187187988063453647259536006414751389435068149050542",
  "22926226526186282614070177468459261234894759514398015935027117294413419812315",
  "19615071067935278619418203782862818504938766309202725358778453138817385278250",
  "24122076977268283964745354700076570091267482751239300078747981833146977210883",
  "27940406969167797832358092280485559147111607951201342107888391347671359583103",
  "4518241738589579050306117143406360197225218409980296383092489433158583319233",
  "27959922629393971329938610412472787493562898346927965016540702113282463916816",
  "3168100032710725933059854026088199857442434512661334208848134916847153160891",
  "19095249513651019402362460108583739897459286231631363694409124159928139291243",
  "13781829820238350950865573473720247051324446162475536076546290189741348403019",
  "21299141573169298742096003211922385057269591957735880225319996549150308342430",
  "22634508631772777681325897382290750488419862706180016629399344640216470114316",
  "26012371157618017396549877110910885490451526604721435544726891429824299578216",
  "15206735453263869017244353809040334303330406984035729650151253256698727408295",
  "13198724063623057145638925150722955158546495752259325022111192292524214248450",
  "23307899375580709201570886942033092308208507331692111548662631544353343551074",
  "16072833470059176793813988685593162040287752736076846319039490137778754588811",
  "11922531372848981077643002493577276097345500662973267725772164134061611555816",
  "16251984045464803983918588061617794740569875331970757581310962162707211210063",
  "20219900569127005878782897167489002163130447102748965777912965571129513908800",
  "14789939091495325198344394913697880373002602157124197757757429064321290551858",
  "23630246258699470616098612879162794949884499993927490725921460369835040019992",
  "20490485566277061645904235678110555097971850606061640840857572463146783351040",
  "27349066769585104401795310777118220660589592247520992320961286980187397902843",
  "24810053308729471547531582858652035334457067106696612098735657182354085372383",
  "22488521725145026105416693797764126583963804976525026129082914502807720464280",
  "14486450824759523893063011850542772481481046348191945493139350715363568534625",
  "13583060413766452870830749821531368642173925372511830564105842188248043789024",
  "22386991529414766955163618314346322952423569043005809791954086253335243455007",
  "23149156119453133668330740159968171246030542445418849267259757347814712598565",
  "11613667606734061735157709866090081348002402645643946664394059492601744676211",
  "9555427143808005043050442648502658737276641799087777384952620714647539186",
  "6083007969584524204907205156320151572339328492731734473215675202750161648043",
  "10725974710609020341124787714865557938475430266924429008345742209042461519435",
  "17612958578431821701843228860584540992780941598593700012943385429246127762960",
  "26090455412415919347018725668289768726152229692641148321623447438838574913213",
  "18737906317579734621246089632810273209012229586109516366812045774795865281199",
  "24762221524254549749835480530833423772455207900501304310523823393155587238755",
  "28218611576038668137067013221857437902460403689761290044665708680255296579315",
  "6400556894443100595280866866901378946198984145367213676003331704124825833315",
  "25231814407422660047883457650944252943799965255620070496887271110263148533050",
  "23565135094261908940133348901630330312775833586462763059578555459605908002800",
  "14774135333476506006618560494992645230519745355262735399830329856902742528171",
  "9346303358276653363574903287052316088209686311220638135169307025854596846516",
  "6185227893878053761340480095207513254923735712015558768434073429910558771362",
  "5491583806386762291586226949113163001298865195134661873868064784092076516170",
  "11816421223574010447645723460629984691645589694247573107377401118625189653358",
  "17892686106353303712110784275034642791517300098084615534917297474680784646556",
  "10187191568189854650027560175574196414298464167187143306911224281611062790637",
  "2880783736934453305354765041734264125840113919048027663266601381528669802667",
  "2569355031261952729335067064241301855281746742067112652006847424005731804847",
  "27486067775837334392192239288562030684149144833169896886253118545626223549169",
  "26715205570955625453587817698274784511348844798907389116259430262709150855816",
  "23454801400418172432606925788809530740929767692923949202748585748938839726965",
  "205594909067062556880793908872148814415323614400927455141443098280941777289",
  "22793840338888371899880778695513175971734977855353319831488825802935102568894",
  "10315480246250880136196852834076897044072040986922155435885093872417536428988",
  "15164557505411156698310007589033782848149855432908850967465538193865417378382",
  "11427558164530543134971507106339887434853108068877073127505103576146379333743",
  "10222782664054335763467742208658993099051842895366268810158645382949062668194",
  "24899110671851793444570092845113091861142599468660753080834415312946490296003",
  "8403607909695348100962321552536443797157884153585174599438346998266447646385",
  "12342703562329787928915759409614528650103188460326423850328609738540950390066",
  "20809281961778447995283721164397267672347042405753448019731100582774657074990",
  "3611739875344255145815568062647366483285841019643640218364561062320636591107",
  "24541934163180154939398612063445978677469153658573044159167336190075141487118",
  "7938623896159588648211250751393231999279594844566364211959414123565357738490",
  "25064293168568740829015815014796084027259828790341342840431540027894832017311",
  "13654678620300204202021998349128632311274615591625676606530575733373031449779",
  "21342174499740577261014978470011907836067377090914991560855122044510915580035",
  "23939970196864252712724013802982684419498796875962856714513978244444351943524",
  "24423732291957489564565697521967986568877933450097113591366696614106664205584",
  "7392638570049996076333672829229835894453598330891009868793820059379929803751",
  "2866053855818710425442388775099273492227915337990290319145750785082512509261",
  "13798690902336677232301369289637147513185919962498830359775265447401225226763",
  "17263383431041231304881267395180073975183351693765845799322710293025980229779",
  "12886760981124836090421399539343058632120295865861475871633222671048569306099",
  "27224139454296533188739912464154574155783432441818676278606137160965256661409",
  "15699356480412282650592257112446095081451871474846507866590836108324755284885",
  "2922734988334382268792302932993809562796996426049926508043910003602697237000",
  "2823303792623634831036477586044249340310569893780400238958878160719209791089",
  "24628280852911260439290507741746599684949000976308596356078067378842914571902",
  "25515310604477403854080058463167378029318466244207126584487754375563880257919",
  "20827797707357193694477441295343400181516958125533180393166597292230773640928",
  "19448728029828160448412364711473335195725166441843456157104846774194524358614",
  "1426895170677888344581909979867971815583908305365791877709387451349661404736",
  "27276497294030248096763274637169258550548830071271101433748274860035850109959",
  "4920394612714347611885739187129051280055846277889226395108471069796350086065",
  "22675863490305461880147900934386328299077933898683085986642590790570206379659",
  "3553728719295040536904295693338476697816151432652452755672665059203919318293",
  "27544775415308093661323323661554988427080699770122008832075095964899305782007",
  "14374098217755051817599275494424156459610614525376785370010334053544035182700",
  "25502752227874896006679965424047706751330412348536165010585118307889317879389",
  "27146364596700395677431780714520224910625033932287488174810422806851782659433",
  "3086284985158487927175321241796717413306484763727779823651535984927722402936",
  "17422752086364932430656224362136593172033384444883030121905520026503810727661",
  "22927655632804684054896838661495554386518561538537535154387277947714619058864",
  "15896265081535037385077826137730510624346199790132300254549129408239327736309",
  "12361084734399856957947109785853052830531335444032261031090815373414823720090",
  "8533242873216920672413960581810293406005823197119750435947680298773035421846",
  "8498687798973122860885679059129575138705627954756267931716268404293360511317",
  "14247998843085281882865528967730497619572327293417008882028985068007821717992",
  "18002055122560117019605412974564465450175685192936048954188631760736295256230",
  "17861904917805683484740212478624125823279558282927987391868536459430597055023",
  "17755406207003821954328891958539621111540710486135005532519762345792334707943",
  "1478970205654883206852129986334055808528561589833249699860523445421590014895",
  "2542788411414185436283710367344970762248717213891971074164596396739093591229",
  "22051299379001012123325643651487892903039051256148523317226003595755888734477",
  "16760311454552365665936779723033614789780188509932151160242539466551337004668",
  "2438103423214363004218519457699639898297895769323468319319318730100851918778",
  "21729552022472877124901853264133377388736489552526812089335459564859506020658",
  "17697201784519746739211723005785171213852692615804536978869510264478697882630",
  "11919617199495692892848087864658921274501670244351203031610723891059410970574",
  "17722188385233903420900985666541210196459611796930746090736301159330048111453",
  "6973506606476675477380614649464576481130617810282107669038744726519886473764",
  "4613631578621872752265913564331421150253141086579683642071259344651041530384",
  "5899304451075682288001686676979614703738948096089169576336853087007349854655",
  "11194882723863087595898682294841294062309651202833537934313196415002223719859",
  "20578307853540267476494220278784910248588687096101959975265695783658151313020",
  "11889177517203750485627995306010151589891785822081195199916386403160835626771",
  "8875783252421178749167560747903703170336369930645063199653163066235837583799",
  "2663846698809656524646474017989550006715435678413537498097292505658087287500",
  "14462850341944425158469287364811764634964209724757834038104652206806391416692",
  "28451783948892792032577733327063771359553582384433333533381109460771731244331",
  "5954699821083037079267618344385255562043752729472639453173887594477793143872",
  "16571984345855276331077487999858820190812295655339042888814135569365720037532",
  "24849927456961124665296490924009239697737822455851947940421257775634021790359",
  "8236592235782123472136858016418783329389410744990040443013361470326417364125",
  "16585219445412299044809943814856560608765175357390288318299568856488945297258",
  "27325837166543253667556523015983609508930185181683806843117272152330654121009",
  "28793024167516212707362161104526247922421156224626640773194113545464233575093",
  "22414561950649246262660564935274107057993944132444677728511929562343060609858",
  "7641750976638737981233906636324979834373733763021669962322299128142208177480",
  "12667544737441855211988034721286181696325246260851662980046589154193585969068",
  "14529903966389546239468665734126880128262946505063407079448281755749276024969",
  "27940422424329738594455235064097214001733071994883485911639965361724272286470",
  "16389796308665823590341256793543282443565720397128509590422779345655217364566",
  "22455229152967312760779262050464039982621024849405796343545480220883390170865",
  "8598543513040807608414012245785481264188456684179944952472699200054386590043",
  "20537097150430388881799646868871323199142596036071815464588983671334200044430",
  "25934740597491517376026157125078984015717526319787316082937057148692992982101",
  "22929218658775212355786836167078926558356831258090293520551577381427729696856",
  "16123649518893840970259906850805687950079970716604761502543442953889296236288",
  "25638669356021204939637981662100413601147563142707271708493165657085772305871",
  "10224745181554310128834416692337252072191417779139720421408886086048785655929",
  "27098903085288552585181219217666396195009647186773028351082551189552358875394",
  "11872730604089910960461213225363107384463303518983874530409980616749407935203",
  "122881123150446761871503443592624013148055414310896104919113975766418384576",
  "3738463026265238343482489214352704796785809331580367403872436715822943999980",
  "26831882361162795929020167284220836555173041182045130248910095283609248767518",
  "25727726614201942667485418710223257712558686666741412139345662375790899268649",
  "22860586377710576204200562021983898118263988887806849333422809218956976800338",
  "7499292523380533283411758673241184815467394953076165791928087920122188232029",
  "6066475385018429943849512469475006226685668398774970403389151839088884796171",
  "15237273544581083279907769205270276295214647929754685664498041536039602664702",
  "3109290784919945189896520815504522296397645817974470719482708216434982177679",
  "4674805511942291391628185344490549172322652329850468396614966167825911789290",
  "17667598330556478906884178681890097421756433041333904794455717449007792363157",
  "21907485507877087983808376648588333059841901521387954071087349905057481744187",
  "20251455609202282162543022284759960100444823935254335771850808741643468727509",
  "16836160367878540055661085675307225979460621325267870603235862336222583034535",
  "26316878444350673236226735265511871328900811902656394828675993221323317128797",
  "956572269965718044543225187262000073004965467074971414177037932541748853289",
  "11507309097435011706556657921334289814120531804308327168509383734886202636538",
  "2159772822628803167686892021941962216938647692557898124729185622544065668725",
  "4471871040380566766812691113719937290459747296592956349066121798052962209156",
  "20547952737007998206419441714987274392699161866360163631256150535884276415180",
  "28876055878738456039724735090619926054975475699141330470629659083477882668181",
  "7967722525563490481214279540736643097830154487889085342768677721046717004633",
  "16175852673925614388487626753629905136570776184182347112350481901463561001944",
  "25608873875556121057488500482896554994727184900145050604843888487433289267298",
  "24187391023641530561854670010200870630032588927139342688062578585725904906936",
  "1261039577252151909029956526087931862537341879636285253498707773421501894688",
  "2869482309779396059094628494040477387203611723338049231263096209821136551443",
  "21138030633245839610738843027069192600186368630255076086224971135918829616409",
  "5444268006626200312131579031684321111895849138606384291292571998743461421804",
  "2261100619556477227797772372912641557287253993255035652633621211721637624142",
  "283280788582982298278839940047978905903143585441837663970871095611201378313",
  "12563080537936264638706743500388127215792703219084014449739006164921024125661",
  "27206449679106395386233308391427045431879069128686675974541922748993480910535",
  "7306892701926649762319328181330492313700746703539178590678860370212642003187",
  "1780599425550960512699559111627643963666762665147269587554010333023912610578",
  "24522385615793158594423768917027798560579679364260221149338274362830688291029",
  "6417979719455302042655490051221588986889868612058358432307577205746658846419",
  "3323374611033779745877878266365704256002027619911743214526934358290311466426",
  "5596015043858761185323231501912141156383497058805938909276059125470499601025",
  "3675649255255192672120575285443408115667578518550199447356597293944743783710",
  "8672375327891405650246553500755514109701354447112715845060230819303799179239",
  "8054385549032843380430219735376365078795223347779202618914938646945477825810",
  "10485873634048118549923350896479614535357504572757809872828910838322532104682",
  "28121893357163601330481478750072388822411904113888884068640978759019873912978",
  "1494093633695034132738510393788154914876120224886123753828093056826312205267",
  "2211159720266308828397658560669651594222333088499360569168428349400514862275",
  "14402944941752650143467287902724320616376074750392526361769080351461440824925",
  "27605577852103035524226291438990319565070564643338495924463954996122670273512",
  "8829048542786317394551937585646379393936299741086271343363910281217551212186",
  "4801459547961338106751149209500421868045001106814131902478472664727711517083",
  "8001651051936344870509540433244099483651667647098171418946009880574307594853",
  "4878881474045422556949597246844466901879156786925380353092275144777408794280",
  "19266306490569120984704494734792767957168369283186657750709762853796611855511",
  "26255047255827315040171878494472872212790979383138280345936305600421390486836",
  "10283949200061596217999100597641061207500781296459801119522775400793727705356",
  "26989720264975154999899910073310704663214758730600092995756266091445056292100",
  "5313260183623395465546626555250107693979169803825874580257800224626231400546",
  "18620089154986073921775485833903974920967177953215776498978719509375407117991",
  "26160302161644249217966199421168413287211657683826898242524308506324219097999",
  "16965086553418914030775236983397650384503587734089833991096904794050988735506",
  "18911289531268456486381812314534214344680024360656785109039859727591876447603",
  "18901794318915657258864604596626958636344417619568296483205555864174237208889",
  "11523223978930226668187075967186589162150668753351939790662129711363886531592",
  "10776815195236834108513573893620076204399038058037331521103900251826716040694",
  "14906716244905586137443399670015674022778690433352360656957603700979631249583",
  "1595882500706627090628223865916130978823518327413056966224108231133188839443",
  "3478076457348553912931280256721156313954681170099997419837804885714829219139",
  "23608743534775444152643844969364449877472485679227393007032753848028139577509",
  "12558181196604778300821789128529042460907731874564028846418348019858119259535",
  "19458409754574298083451886811627318588193986223236301160002547348325343034193",
  "3437330703170601441315573853028003721131691328173551136679594518986347639897",
  "6847780154971446579390091777018140419181182455478420828211111888640067082513",
  "5770651577168586598154171570615878128860793360886240680290364294979081312172",
  "11090669304512636127491665239014502711754177294029090043247281298293601521385",
  "26339579249570229829091036047138719468398315941393908904530766716294372398581",
  "13595794470630681491484167475864477949382139581418918902566381283644495277041",
  "15244108684288754986509830253735777675965048284477952531094407241028094537496",
  "27894277895734450359459686781119365250527872774175225541984743870279272873208",
  "7300720355692210728318063598111173079844524108004474114201218371315607732010",
  "8640356508133316273948838800493116275781578484030819111101953171907370351213",
  "12493170184892254488124904530485378181920376614588647420580561348449083175476",
  "7976425914825155762303074620281466997218325269629616831025443989589224772775",
  "11165261569419881477261584730900096190366527425203894389361291820894511934152",
  "24534411440091713236009457450611067555886950039197467693481823532162546809582",
  "17654458256528287864919092712661619740010252015889010051529814208267725323504",
  "26008847130228522851488907712860427266214347000205630622898123226921647548963",
  "24369223210693470211219555411491773798680814263256654469325512190018483304935",
  "3041746592923350985396404103515346650409131596217456756485089208494938422024",
  "417487080996983389666087182949800583451903177094887102376858131202113095769",
  "8025524475183148287918931118169440864276715864624241855739289265230484972077",
  "8096909211244448543535290418681700851154444508263707025641139226606115495183",
  "5880063417032089592755513876118923319209198206195066299052500376329466508703",
  "17851521420302570176893509876801894933653574735672038178838797014458183114748",
  "22520311029207695279470685647123557096410145740495012387805647514028363960785",
  "8701630015350694948882876436936365053751186496824688055261804722932901986571",
  "8612400359031903462383505059681926453612019815540237337443718665778832432340",
  "10998457382417127910958502274665876769707965442922441317559258506775821370689",
  "4547654532974682206288067100165781973774074080946727517737593797380768570960",
  "16777629290202890894530000867950524848471692367147269350322408870801830859137",
  "19220203479877631620213689523913254943108643829488611893839873310399125839359",
  "1941455833116700385501158482199028736147232545773185794040276976802291129266",
  "2730184383153545643374818711896869942419135909453172793896379777633890464623",
  "15524703535784356490892003650043474741938502708936836457184574755711287582655",
  "14653732074916419598634371615664028756091506187140689277740651696042307797809",
  "9788754814205769365130298485199779099554008334056830718182679059108188702371",
  "21317550028762003372309118242148739846105449043285695472070185993175623059443",
  "488848421282476680191023790784673486008085095922406253875865484075352517203",
  "2204101333435458417898461512607927089255268713782795365824920336491153446919",
  "8685214998835409280986595670939203723070792327335041345464665507718589581381",
  "16612670222587404229462233644043288108471956070833847079173799204898278723146",
  "24290345825826532235064283060749756969984887997413728233860626892935564509864",
  "4434916133500103474110237263148344143009991721311102956859483247291614289294",
  "13176845990972251839979710407202266272227768891877913611286223229957015294985",
  "13973730998739583041712614331780518039989940143747502401908262669825856016573",
  "235449976145513856110697107171269639099811400486729076070778216829603428416",
  "6250492953038227578534429519634531835786100533285110635611283309306696873224",
  "21911616275636547129907674249526672086934486016670095994934628400054357594229",
  "27819600835797757328393613561469727164597116718526456830337831800514105193715",
  "10989484578077760856288678713696832156526464023583583327462156834120250940328",
  "9832659977048288019143782844611482669886305578232831698959719562886771650500",
  "16350439574723760060277437821685329705925210573447249134307313607475605332154",
  "25491195506314276169688365318362609785395366355040318371204299570425510017752",
  "19425966354489337632951869312999732052182783763963504453497152910969532196226",
  "12053958171376183987800670421222213605055487000875776706495934170550066308511",
  "24329510683435325881921639557055635253572330245316319922955128790300424873267",
  "12252359106110902480794697234262454810993030593273106390866223680597737219825",
  "10862922193102371732177870179442802377570115845627660330463795996872215215003",
  "20986474342654282014524028896983753098271209972996377938037565940867053302802",
  "24733872138507609135685972186417086010313774123449464153498947896693929206129",
  "12729171297735026786139838054574365727245112762334503441449651297991052692414",
  "22461026844553526261227374612777755695748399950802023517481038420054138653274",
  "27197857252833404455369432540411793234765308846278883988739335459112138940043",
  "14232888790612416144504656634350823552381833733501401212201469801199050592720",
  "5328858711963843979393354652351468346339624134148601981335291526061216698247",
  "14902484767001726779813539168887613147425922496841741260137059233052320325192",
  "10224345287182324364360064198905162618280139560649364072694708261170701838257",
  "7151137787034853634513499874732843072860432018665284914478256575041570324035",
  "24380721009533817208241446738317197070417409563573028126709309321377877349991",
  "14349469109482514249924419739715084539664895908852617715900341202087630625341",
  "19762929141065879323142619414578719703371634159452168113220522900136614354228",
  "461572424898657536143288324662123379121003872853639439390418990231840000005",
  "26423832711104606060985946021824830240775505838049855749920584215749214573911",
  "3667789288529663920896272489305123165721276934187479846014969407962455769944",
  "8709886565621309467884983856771682917056275539182499618342146926296467178114",
  "5901562314830803765454381019755854147277423400356133534478879878580458051892",
  "3926185429967494740714247595534040908393742956198862016404678897857632469147",
  "21322618704779681205904545814828665121394935279056407301183266602520519621482",
  "22288064036815396976261507414179729706130994126986584226346891235774988885845",
  "23197396981204804805417733019320525930321914983278074519100672409074724880105",
  "26573398893009529047529578252755560936814606251100138232085004412442909152240"
];

utxo_hashes.forEach((hash) => {
  commitmentMap.set(Field(hash), Field(hash));
});

console.log("Commitment map generated!");

const worker = new Worker('proof', async job => {
  const transactions = job.data.transactions;

  try {
    await putFile(transactions);
  } catch (e) {
    console.log("Skip sending transactions to Filecoin");
  }

  // json to snarkyjs types
  const convertedTransaction: Transaction[] = transactions.map((tx: any) => {
    const input_utxos: UTXO[] = tx.input_utxos.map((utxo: any) =>
      UTXO.create(
        PublicKey.fromBase58(utxo.public_key),
        Field(utxo.amount),
        Field(utxo.salt)
      )
    );

    const output_utxos: UTXO[] = tx.output_utxos.map((utxo: any) =>
      UTXO.create(
        PublicKey.fromBase58(utxo.public_key),
        Field(utxo.amount),
        Field(utxo.salt)
      )
    );

    const signatures: Signature[] = tx.signatures.map((sig: string) =>
      Signature.fromBase58(sig)
    );

    return { inputUTXOs: input_utxos, outputUTXOs: output_utxos, signatures };
  });

  const stepInfos: any = createStepInfos(
    commitmentMap,
    nullifierMap,
    convertedTransaction
  );

  console.log("Step infos generated!");

  commitmentMap = stepInfos.commitmentMap;
  nullifierMap = stepInfos.nullifierMap;

  console.log("Proofs generating...");
  const proofs = await generateProofsParellel(stepInfos);
  console.log("Proofs generated!");

  console.log("Proofs merging...");
  const proof = await mergeProofs(proofs);
  console.log("Proofs merged!");

  const res = await callContract(proof);
  console.log(res);

  await putFile(commitmentMap.getRoot().toString()); // TODO: Should be all tree
  await putFile(nullifierMap.getRoot().toString()); // TODO: Should be all tree

}, { connection: connection });

worker.on('completed', job => {
  console.log(`${job.id} has completed!`);
});

worker.on('failed', (job: any, err) => {
  console.log(`${job.id} has failed with ${err.message}`);
});

interface IPostBody {
  input_utxos: object[];
  output_utxos: object[];
  signatures: object[];
}

server.post(
  '/prover',
  async (
    request: FastifyRequest<{ Body: IPostBody[] }>,
    reply: FastifyReply
  ) => {
    const transactions = request.body;

    const job = await server.proofQueue.add('proof', { transactions });
    
    return reply.code(200).send({ success: true, job_id: job.id });
  }
);

server.listen({ port: 3030 }, async (err, address) => {
  await compile();
  if (err) {
    console.error(err);
    process.exit(1);
  }
  console.log(`Server listening at ${address}`);
});
